{{- if .Values.istio.enabled }}
{{- if .Values.istio.gateway.servers }}
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ default (printf "%s-istio-gateway" (include "pipeops-gateway.fullname" .)) .Values.istio.gateway.name }}
  labels:
    {{- include "pipeops-gateway.labels" . | nindent 4 }}
    {{- if .Values.istio.gateway.labels }}
    {{- toYaml .Values.istio.gateway.labels | nindent 4 }}
    {{- end }}
  {{- if .Values.istio.gateway.annotations }}
  annotations:
    {{- toYaml .Values.istio.gateway.annotations | nindent 4 }}
  {{- end }}
spec:
  selector:
    {{- toYaml .Values.istio.gateway.selector | nindent 4 }}
  servers:
    {{- range .Values.istio.gateway.servers }}
    - port:
        number: {{ required "istio.gateway.servers[].port.number is required" .port.number }}
        name: {{ required "istio.gateway.servers[].port.name is required" .port.name | quote }}
        protocol: {{ required "istio.gateway.servers[].port.protocol is required" .port.protocol | quote }}
      {{- if .hosts }}
      hosts:
        {{- toYaml .hosts | nindent 8 }}
      {{- else if eq .port.protocol "TLS" }}
      hosts:
        - "*"
      {{- end }}
      {{- if .tls }}
      tls:
        {{- toYaml .tls | nindent 8 }}
      {{- end }}
    {{- end }}
{{- end }}
{{- if or (.Values.istio.virtualService.tcpRoutes) (.Values.istio.virtualService.tlsRoutes) }}
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ default (printf "%s-istio-vs" (include "pipeops-gateway.fullname" .)) .Values.istio.virtualService.name }}
  labels:
    {{- include "pipeops-gateway.labels" . | nindent 4 }}
    {{- if .Values.istio.virtualService.labels }}
    {{- toYaml .Values.istio.virtualService.labels | nindent 4 }}
    {{- end }}
  {{- if .Values.istio.virtualService.annotations }}
  annotations:
    {{- toYaml .Values.istio.virtualService.annotations | nindent 4 }}
  {{- end }}
spec:
  hosts:
    - "*"
  gateways:
    - {{ default (printf "%s-istio-gateway" (include "pipeops-gateway.fullname" .)) .Values.istio.gateway.name | quote }}
  {{- if .Values.istio.virtualService.tcpRoutes }}
  tcp:
    {{- range .Values.istio.virtualService.tcpRoutes }}
    - match:
        - port: {{ required "istio.virtualService.tcpRoutes[].port is required" .port }}
      route:
        - destination:
            host: {{ required "istio.virtualService.tcpRoutes[].destination.host is required" .destination.host | quote }}
            port:
              number: {{ required "istio.virtualService.tcpRoutes[].destination.port is required" .destination.port }}
    {{- end }}
  {{- end }}
  {{- if .Values.istio.virtualService.tlsRoutes }}
  tls:
    {{- range .Values.istio.virtualService.tlsRoutes }}
    - match:
        - sniHosts:
            {{- toYaml .sniHosts | nindent 12 }}
          {{- if .port }}
          port: {{ .port }}
          {{- end }}
      route:
        - destination:
            host: {{ required "istio.virtualService.tlsRoutes[].destination.host is required" .destination.host | quote }}
            port:
              number: {{ required "istio.virtualService.tlsRoutes[].destination.port is required" .destination.port }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
