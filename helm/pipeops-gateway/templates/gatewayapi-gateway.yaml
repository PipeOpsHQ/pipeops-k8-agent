{{- if .Values.gatewayApi.enabled }}
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: {{ default (printf "%s-gw" (include "pipeops-gateway.fullname" .)) .Values.gatewayApi.gateway.name }}
  labels:
    {{- include "pipeops-gateway.labels" . | nindent 4 }}
    {{- if .Values.gatewayApi.gateway.labels }}
    {{- toYaml .Values.gatewayApi.gateway.labels | nindent 4 }}
    {{- end }}
  {{- if .Values.gatewayApi.gateway.annotations }}
  annotations:
    {{- toYaml .Values.gatewayApi.gateway.annotations | nindent 4 }}
  {{- end }}
spec:
  gatewayClassName: {{ .Values.gatewayApi.gateway.gatewayClassName | default "istio" | quote }}
  {{- if and (eq .Values.environment.mode "single-vm") .Values.environment.vmIP }}
  addresses:
    - type: IPAddress
      value: {{ .Values.environment.vmIP | quote }}
  {{- end }}
  {{- if .Values.gatewayApi.gateway.listeners }}
  listeners:
    {{- range .Values.gatewayApi.gateway.listeners }}
    - name: {{ required "gatewayApi.gateway.listeners[].name is required" .name | quote }}
      port: {{ required "gatewayApi.gateway.listeners[].port is required" .port }}
      protocol: {{ .protocol | default "TCP" | quote }}
    {{- end }}
  {{- end }}
---
{{- range .Values.gatewayApi.tcpRoutes }}
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
  name: {{ required "gatewayApi.tcpRoutes[].name is required" .name | quote }}
  labels:
    {{- include "pipeops-gateway.labels" $ | nindent 4 }}
spec:
  parentRefs:
    - name: {{ default (printf "%s-gw" (include "pipeops-gateway.fullname" $)) $.Values.gatewayApi.gateway.name | quote }}
      {{- if .sectionName }}
      sectionName: {{ .sectionName | quote }}
      {{- end }}
  rules:
    - backendRefs:
        {{- range required "gatewayApi.tcpRoutes[].backendRefs is required" .backendRefs }}
        - name: {{ required "backendRefs[].name is required" .name | quote }}
          {{- if .namespace }}
          namespace: {{ .namespace | quote }}
          {{- end }}
          port: {{ required "backendRefs[].port is required" .port }}
        {{- end }}
---
{{- end }}
{{- range .Values.gatewayApi.udpRoutes }}
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: UDPRoute
metadata:
  name: {{ required "gatewayApi.udpRoutes[].name is required" .name | quote }}
  labels:
    {{- include "pipeops-gateway.labels" $ | nindent 4 }}
spec:
  parentRefs:
    - name: {{ default (printf "%s-gw" (include "pipeops-gateway.fullname" $)) $.Values.gatewayApi.gateway.name | quote }}
      {{- if .sectionName }}
      sectionName: {{ .sectionName | quote }}
      {{- end }}
  rules:
    - backendRefs:
        {{- range required "gatewayApi.udpRoutes[].backendRefs is required" .backendRefs }}
        - name: {{ required "backendRefs[].name is required" .name | quote }}
          {{- if .namespace }}
          namespace: {{ .namespace | quote }}
          {{- end }}
          port: {{ required "backendRefs[].port is required" .port }}
        {{- end }}
---
{{- end }}
{{- end }}
