{{- if and .Values.istio.enabled .Values.istio.service.create }}
apiVersion: v1
kind: Service
metadata:
  # Allow creating the Service in the istio ingress namespace, even if Helm release is elsewhere
  name: {{ default (printf "%s-istio-lb" (include "pipeops-gateway.fullname" .)) .Values.istio.service.name }}
  namespace: {{ .Values.istio.service.namespace | default "istio-system" }}
  labels:
    {{- include "pipeops-gateway.labels" . | nindent 4 }}
  {{- if .Values.istio.service.annotations }}
  annotations:
    {{- toYaml .Values.istio.service.annotations | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.istio.service.type | default "LoadBalancer" }}
  {{- if and (eq .Values.environment.mode "single-vm") .Values.environment.vmIP }}
  loadBalancerIP: {{ .Values.environment.vmIP | quote }}
  externalIPs:
    - {{ .Values.environment.vmIP | quote }}
  {{- end }}
  externalTrafficPolicy: {{ .Values.istio.service.externalTrafficPolicy | default "Local" }}
  selector:
    {{- /* Target the istio ingress gateway pods */ -}}
    {{- toYaml .Values.istio.gateway.selector | nindent 4 }}
  ports:
    {{- $ports := .Values.istio.service.ports }}
    {{- if not $ports }}
    {{- /* If ports not explicitly set, derive from istio.gateway.servers */ -}}
    {{- range .Values.istio.gateway.servers }}
    - name: {{ .port.name | quote }}
      port: {{ .port.number }}
      targetPort: {{ .port.number }}
      protocol: {{ .port.protocol | default "TCP" }}
    {{- end }}
    {{- else }}
    {{- toYaml $ports | nindent 4 }}
    {{- end }}
{{- end }}

