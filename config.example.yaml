# PipeOps Agent Configuration - Production Test
# Testing against live control plane: https://api.pipeops.io

# Agent configuration
agent:
  # Unique identifier for this agent (auto-generated if not specified)
  id: ""
  
  # Human-readable name for this agent
  name: "test-agent-001"
  
  # Name of the cluster this agent manages
  cluster_name: "test-cluster-001"
  
  # Labels to apply to this agent
  labels:
    environment: "test"
    region: "local"
    managed-by: "pipeops"

  # Compatibility settings for existing clusters
  # Use this when deploying the agent to existing clusters with pre-configured infrastructure
  compatibility:
    # Compatibility mode: strict (fail on conflicts), relaxed (warn on conflicts), force (override everything)
    mode: "relaxed"

    # Ingress controller compatibility settings
    ingress:
      # Enable automatic fixing of NGINX Ingress ConfigMaps (opt-in for safety)
      # Default: false (disabled to prevent unwanted modifications to existing clusters)
      # Set to true to allow the agent to automatically fix ConfigMap settings
      auto_fix_configmaps: false

      # Require annotation before modifying ConfigMaps (recommended for production)
      # If set, ConfigMaps must have this annotation to allow modifications
      # Example: kubectl annotate configmap ingress-nginx-controller pipeops.io/allow-modifications=true -n ingress-nginx
      require_annotation: "pipeops.io/allow-modifications"

      # Backup original ConfigMap before modifying (recommended)
      # Saves original configuration in annotations for rollback
      backup_before_modify: true

      # WebSocket support settings
      websocket:
        # Ensure HTTP/1.1 upgrade support for WebSocket connections
        ensure_upgrade_support: true

        # Disable buffering to prevent interference with real-time WebSocket data
        disable_buffering: true

        # Set appropriate timeouts for long-lived WebSocket connections
        set_timeouts: true

        # Timeout in seconds for WebSocket connections (default: 3600 = 1 hour)
        timeout_seconds: 3600

        # Verify ingress annotations for WebSocket services
        verify_ingress_annotations: true

    # Monitoring stack compatibility settings
    monitoring:
      # Reuse existing Prometheus/Grafana if already installed
      reuse_existing: true

      # Install monitoring stack if missing
      install_if_missing: true

# PipeOps control plane configuration
pipeops:
  api_url: "https://api.pipeops.io"
  token: "<YOUR_PIPEOPS_TOKEN>"
  timeout: "30s"
  reconnect:
    enabled: true
    max_attempts: 3
    interval: "5s"
    backoff: "5s"
  tls:
    enabled: true
    insecure_skip_verify: false

# Tunnel configuration (Portainer-style direct port forwarding)
tunnel:
  # Enable/disable tunnel functionality
  enabled: true
  
  # Inactivity timeout - tunnel closes after this period of no API requests
  inactivity_timeout: "5m"
  
  # List of ports to forward through tunnel (Portainer-style)
  forwards:
    - name: "kubernetes-api"
      local_addr: "localhost:6443"
      remote_port: 0
      
    - name: "kubelet-metrics"
      local_addr: "localhost:10250"
      remote_port: 0
      
    - name: "agent-http"
      local_addr: "localhost:8080"
      remote_port: 0

# Kubernetes configuration
kubernetes:
  # Path to kubeconfig file (leave empty for in-cluster config)
  kubeconfig: ""
  
  # Whether to use in-cluster configuration
  in_cluster: false
  
  # Default namespace for agent operations
  namespace: "pipeops-system"

# Logging configuration
logging:
  # Log level (debug, info, warn, error)
  level: "debug"
  
  # Log format (json, text)
  format: "text"
  
  # Log output (stdout, stderr, file path)
  output: "stdout"

# Optional: Env-aware TCP gateway
gateway:
  enabled: false
  namespace: pipeops-system

# TCP/UDP Tunneling Configuration (NEW)
# Enables tunneling of TCP/UDP services exposed via Istio Gateway
# Use cases: PostgreSQL, Redis, SSH, custom TCP/UDP services
tunnels:
  # Enable/disable TCP/UDP tunnel discovery and forwarding
  enabled: false
  
  # Routing configuration
  routing:
    # Force all services to use tunnel mode (bypass public detection)
    # Useful for security or when you want all traffic through PipeOps gateway
    force_tunnel_mode: false
    
    # Enable dual-mode for public clusters (both direct + tunnel endpoints)
    # Provides redundancy and allows clients to choose connection method
    dual_mode_enabled: true

  # Gateway API resource discovery
  discovery:
    tcp:
      # Enable TCP gateway discovery (watch for TCPRoute resources)
      enabled: true
      # Label selector for managed gateways
      gateway_label: "pipeops.io/managed"
    
    udp:
      # Enable UDP gateway discovery (watch for UDPRoute resources)
      enabled: true
      gateway_label: "pipeops.io/managed"

  # TCP tunnel settings
  tcp:
    # Buffer size for TCP data (bytes)
    buffer_size: 32768
    
    # Enable TCP keepalive
    keepalive: true
    
    # TCP keepalive period
    keepalive_period: "30s"
    
    # Connection timeout for establishing tunnel
    connection_timeout: "30s"
    
    # Idle timeout - close connection after inactivity
    idle_timeout: "5m"
    
    # Maximum concurrent TCP connections per service
    max_connections: 1000

  # UDP tunnel settings
  udp:
    # Buffer size for UDP packets (bytes)
    buffer_size: 65535
    
    # Session timeout - cleanup inactive UDP sessions
    session_timeout: "5m"
    
    # Maximum concurrent UDP sessions per tunnel
    max_sessions: 10000
